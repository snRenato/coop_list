# =============================
# Dockerfile.dev — Ambiente de Desenvolvimento
# =============================

FROM ruby:3.4.7-slim

# --- Variáveis de ambiente padrão ---
ENV LANG=C.UTF-8 \
    BUNDLE_PATH=/usr/local/bundle \
    BUNDLE_JOBS=4 \
    BUNDLE_RETRY=3 \
    NODE_ENV=development \
    RAILS_ENV=development \
    DEBIAN_FRONTEND=noninteractive \
    PATH="/usr/local/bundle/bin:${PATH}"

# --- Instala dependências do sistema ---
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
  build-essential \
  git \
  libpq-dev \
  nodejs \
  npm \
  curl \
  vim \
  && npm install -g yarn \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives

# --- Define diretório de trabalho ---
WORKDIR /coop_list

# --- Copia Gemfile e Gemfile.lock ---
COPY Gemfile Gemfile.lock ./

# --- Instala gems (incluindo development e test) ---
RUN gem install bundler && bundle install

# --- Copia todo o código da aplicação ---
COPY . .

# --- Instala dependências JS ---
RUN yarn install --check-files || true

# --- Expõe a porta do Rails ---
EXPOSE 3000

# --- Comando padrão: inicia o servidor Rails ---
CMD ["bash", "-c", "rm -f tmp/pids/server.pid && bundle exec rails server -b 0.0.0.0 -p 3000"]
